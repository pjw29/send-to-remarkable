<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send to reMarkable</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        .container {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .email-display {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .api-docs {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        .endpoint {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .method {
            font-weight: bold;
            color: #28a745;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üìÑ Send to reMarkable</h1>
    
    <div class="container">
        <h2>What is this?</h2>
        <p>This service allows you to send documents directly to your reMarkable tablet in three ways:</p>
        <ul>
            <li><strong>üìß Email uploads:</strong> Send PDFs or EPUBs to a specific email address and they'll automatically appear on your reMarkable</li>
            <li><strong>üåê Web uploads:</strong> Upload files directly through this website (more of a proof of concept)</li>
            <li><strong>üîå API uploads:</strong> Integrate with other services using our REST API</li>
        </ul>
        <p>I made this because I wanted Readwise Reader's send-to-Kindle functionality to work with my reMarkable tablet. Now it does!</p>
    </div>

    <div class="container" id="signupDisabledContainer" style="display: none;">
        <h2>üö´ Signup Disabled</h2>
        <p>New device registrations are disabled on this instance.</p>
        <p>If you operate this instance, set the `SIGNUP_DISABLED` environment variable to `false` to enable registrations.</p>
        <p>To create your own instance, check out the <a href="https://github.com/zegevlier/send-to-remarkable">GitHub repository</a> for self-hosting instructions.</p>
    </div>

    <div class="container" id="setupContainer" style="display: none;">
        <h2>Setup Your Device</h2>
        <p>First, get a link code from your reMarkable device:</p>
        <ol>
            <li>Go to <a href="https://my.remarkable.com/#mobile">https://my.remarkable.com/#mobile</a></li>
            <li>Log in with your reMarkable account</li>
            <li>Copy the 8-character code that appears</li>
            <li>Enter it below:</li>
        </ol>
        
        <div class="form-group">
            <label for="linkCode">Link Code:</label>
            <input type="text" id="linkCode" placeholder="ABCD1234" maxlength="8" style="text-transform: lowercase;">
        </div>
        
        <button onclick="registerDevice()">Register Device (this takes a while!)</button>
        
        <div id="registrationResult"></div>
        
        <div id="emailInstructions" style="display: none;">
            <div class="email-display">
                <h3>üìß Your Upload Email:</h3>
                <p><strong id="uploadEmail"></strong></p>
                <p>Send any PDF or EPUB to this email address and it will automatically appear on your reMarkable! You can also set your readwise kindle email to this (through some hackery), and use their send-to-kindle function with the remarkable.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Web Upload</h2>
        <p>If you have your Auth ID, you can upload files directly here:</p>
        
        <div class="form-group">
            <label for="authId">Auth ID:</label>
            <input type="text" id="authId" placeholder="Your auth ID from registration">
        </div>
        
        <div class="form-group">
            <label for="fileUpload">File:</label>
            <input type="file" id="fileUpload" accept=".pdf,.epub">
        </div>
        
        <button onclick="uploadFile()">Upload File</button>
        
        <div id="uploadResult"></div>
    </div>

    <div class="container">
        <h2>Manage Your Auth ID</h2>
        <p>Check the status of your Auth ID or delete it if you no longer need it:</p>
        
        <div class="form-group">
            <label for="manageAuthId">Auth ID:</label>
            <input type="text" id="manageAuthId" placeholder="Your auth ID">
        </div>
        
        <button onclick="checkStatus()">Check Status</button>
        <button onclick="destroyAuth()" style="background: #dc3545;">Delete Auth ID</button>
        
        <div id="manageResult"></div>
    </div>

    <div class="api-docs">
        <h2>üîß API Documentation</h2>
        <p>You can also use this service programmatically:</p>
        
        <div class="endpoint">
            <div class="method">POST /register</div>
            <p>Register a new device with a link code</p>
            <pre>curl -X POST "https://your-domain.com/register" \
  -H "Content-Type: application/json" \
  -d '{"linkCode": "ABCD1234"}'</pre>
        </div>
        
        <div class="endpoint">
            <div class="method">POST /upload</div>
            <p>Upload a file using Auth ID (the first part of your email)</p>
            <pre>curl -X POST "https://your-domain.com/upload" \
  -F "file=@document.pdf" \
  -F "authId=your-auth-id-here"</pre>
        </div>
        
        <div class="endpoint">
            <div class="method">GET /auth/:authId/status</div>
            <p>Check authentication status</p>
            <pre>curl "https://your-domain.com/auth/your-auth-id/status"</pre>
        </div>
        
        <div class="endpoint">
            <div class="method">DELETE /auth/:authId</div>
            <p>Delete an auth ID. This will delete the token, and make the auth ID invalid</p>
            <pre>curl -X DELETE "https://your-domain.com/auth/your-auth-id"</pre>
        </div>

    </div>

    <script>
        // Get the current domain for dynamic URLs
        const currentDomain = window.location.host;
        
        // Utility function to safely set HTML content
        function setResult(elementId, type, message, data = {}) {
            const element = document.getElementById(elementId);
            element.innerHTML = ''; // Clear existing content
            
            const div = document.createElement('div');
            div.className = type;
            
            if (type === 'loading') {
                div.innerHTML = '‚è≥ ' + message;
            } else {
                const messageEl = document.createElement('div');
                messageEl.innerHTML = message;
                div.appendChild(messageEl);
                
                // Add data elements safely
                Object.entries(data).forEach(([key, value]) => {
                    const dataEl = document.createElement('div');
                    dataEl.innerHTML = `${key}: `;
                    const codeEl = document.createElement('span');
                    codeEl.className = 'code';
                    codeEl.textContent = value;
                    dataEl.appendChild(codeEl);
                    div.appendChild(dataEl);
                });
            }
            
            element.appendChild(div);
        }
        
        // Update API documentation with current domain
        function updateApiDocs() {
            const preElements = document.querySelectorAll('pre');
            preElements.forEach(pre => {
                pre.textContent = pre.textContent.replace(/https:\/\/your-domain\.com/g, `https://${currentDomain}`);
            });
        }
        
        // Check if signup is enabled on this instance
        async function checkSignupStatus() {
            try {
                const response = await fetch('/signup-enabled');
                const result = await response.json();
                
                if (result.signupEnabled) {
                    // Show the setup container
                    document.getElementById('setupContainer').style.display = 'block';
                } else {
                    // Show the signup disabled message
                    document.getElementById('signupDisabledContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to check signup status:', error);
                // Default to showing setup if we can't determine status
                document.getElementById('setupContainer').style.display = 'block';
            }
        }
        
        async function registerDevice() {
            const linkCode = document.getElementById('linkCode').value.trim().toLowerCase();
            const resultDiv = 'registrationResult';
            
            if (!linkCode || linkCode.length !== 8) {
                setResult(resultDiv, 'error', 'Please enter a valid 8-character link code');
                return;
            }
            
            // Show loading state
            setResult(resultDiv, 'loading', 'Registering device... This may take 30-60 seconds, please wait!');
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ linkCode: linkCode }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setResult(resultDiv, 'success', '<strong>Device registered successfully!</strong><br>Keep your Auth ID safe - you\'ll need it for uploads!', {
                        'Auth ID': result.authId
                    });
                    
                    // Show email instructions
                    const uploadEmailEl = document.getElementById('uploadEmail');
                    uploadEmailEl.textContent = `${result.authId}@${currentDomain}`;
                    document.getElementById('emailInstructions').style.display = 'block';
                    document.getElementById('authId').value = result.authId;
                } else {
                    setResult(resultDiv, 'error', `Registration failed: ${result.error}`);
                }
            } catch (error) {
                setResult(resultDiv, 'error', `Registration failed: ${error.message}`);
            }
        }
        
        async function uploadFile() {
            const authId = document.getElementById('authId').value.trim();
            const fileInput = document.getElementById('fileUpload');
            const resultDiv = 'uploadResult';
            
            if (!authId) {
                setResult(resultDiv, 'error', 'Please enter your Auth ID');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                setResult(resultDiv, 'error', 'Please select a file');
                return;
            }
            
            setResult(resultDiv, 'loading', 'Uploading file...');
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('authId', authId);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setResult(resultDiv, 'success', '<strong>File uploaded successfully!</strong><br>Your file will appear on your reMarkable shortly!', {
                        'File': result.fileName,
                        'Workflow ID': result.workflowId
                    });
                } else {
                    setResult(resultDiv, 'error', `Upload failed: ${result.error}`);
                }
            } catch (error) {
                setResult(resultDiv, 'error', `Upload failed: ${error.message}`);
            }
        }
        
        async function checkStatus() {
            const authId = document.getElementById('manageAuthId').value.trim();
            const resultDiv = 'manageResult';
            
            if (!authId) {
                setResult(resultDiv, 'error', 'Please enter your Auth ID');
                return;
            }
            
            setResult(resultDiv, 'loading', 'Checking status...');
            
            try {
                const response = await fetch(`/auth/${authId}/status`);
                const result = await response.json();
                
                if (response.ok) {
                    const statusMessage = result.registered ? 
                        '<strong>‚úÖ Active:</strong> Your Auth ID is valid and ready to use!' :
                        '<strong>‚ùå Inactive:</strong> This Auth ID is not registered or has expired.';
                    
                    setResult(resultDiv, result.registered ? 'success' : 'error', statusMessage, {
                        'Device ID': result.device_id || 'N/A',
                        'Token Status': result.access_token_valid ? 'Valid' : 'Invalid/Expired'
                    });
                } else {
                    setResult(resultDiv, 'error', `Status check failed: ${result.error}`);
                }
            } catch (error) {
                setResult(resultDiv, 'error', `Status check failed: ${error.message}`);
            }
        }
        
        async function destroyAuth() {
            const authId = document.getElementById('manageAuthId').value.trim();
            const resultDiv = 'manageResult';
            
            if (!authId) {
                setResult(resultDiv, 'error', 'Please enter your Auth ID');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete Auth ID "${authId}"? This action cannot be undone and you'll need to register again to use this Auth ID.`)) {
                return;
            }
            
            setResult(resultDiv, 'loading', 'Deleting Auth ID...');
            
            try {
                const response = await fetch(`/auth/${encodeURIComponent(authId)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    setResult(resultDiv, 'success', '<strong>Auth ID deleted successfully!</strong><br>The Auth ID and all associated data have been permanently removed.');
                    document.getElementById('manageAuthId').value = '';
                } else {
                    setResult(resultDiv, 'error', `Deletion failed: ${result.error}`);
                }
            } catch (error) {
                setResult(resultDiv, 'error', `Deletion failed: ${error.message}`);
            }
        }
        
        // Auto-format link code input
        document.getElementById('linkCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateApiDocs();
            checkSignupStatus();
        });
    </script>
</body>
</html>